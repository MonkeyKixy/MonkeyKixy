<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MonkeyKixy â€” De la jungle Ã  la lune</title>
  <meta name="description" content="MonkeyKixy : aventure mÃ¨me native Bitcoin. PrÃ©vente, histoire, gros Kixy, jeu, posts, chat et staking."/>
  <meta property="og:title" content="MonkeyKixy â€” De la jungle Ã  la lune"/>
  <meta property="og:description" content="Kixy a entendu Bitcoin dans la jungleâ€¦ et a pris la fusÃ©e."/>
  <meta property="og:type" content="website"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="theme-color" content="#0c1718"/>

  <link rel="icon" type="image/png" sizes="32x32" href="assets/kixy-coin.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/kixy-coin.png">

  <style>
    :root{
      --bg:#061013; --bg2:#0a1617; --card:#0f1c1f; --line:#183033;
      --txt:#e8fbff; --muted:#9ab7bd; --pri:#5fe1a0; --sec:#3fb8ff;
    }
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{
      color:var(--txt); font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background:
        linear-gradient(180deg, rgba(6,16,19,.60), rgba(10,22,23,.85)),
        url('assets/jungle.png') center/cover fixed;
    }
    a{color:var(--sec);text-decoration:none}
    .wrap{max-width:1120px;margin:0 auto;padding:0 20px}
    .muted{color:var(--muted)}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;backdrop-filter:blur(8px);
      background:rgba(7,13,14,.85);border-bottom:1px solid var(--line)}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0;gap:12px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:800}
    .brand img{width:28px;height:28px;border-radius:50%}
    .links{display:flex;gap:16px;flex-wrap:wrap}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-block;border:1px solid var(--line);padding:10px 14px;border-radius:12px;background:transparent;color:var(--txt);cursor:pointer}
    .btn.primary{background:var(--pri);color:#022018;border-color:var(--pri);font-weight:800}
    .btn.ghost{background:transparent}
    .btn.xl{font-size:18px;padding:14px 18px;border-radius:14px}
    .select{appearance:none;background:#0a1416;border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:8px 12px}

    /* Panels */
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:16px 0}
    .panel.alt{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01))}
    .hero-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:center}
    h1{font-size:42px;line-height:1.1;margin:0 0 10px}
    .grad{background:linear-gradient(90deg,#5fe1a0,#3fb8ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-weight:600;margin-top:4px}
    .lead{opacity:.95}
    .cta-row{display:flex;gap:10px;margin:12px 0 6px;flex-wrap:wrap}

    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:16px}
    .stat{background:rgba(6,16,19,.6);backdrop-filter:blur(2px);border:1px solid var(--line);border-radius:12px;padding:12px}
    .stat .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .stat .value{font-size:18px;font-weight:800}

    /* Gros Kixy */
    .hero-figure{position:relative;justify-self:end;width:min(46vw,560px);pointer-events:none}
    .hero-figure::before{
      content:"";position:absolute;inset:-6% -4% -8% -4%;border-radius:50%;
      background:radial-gradient(closest-side, rgba(255,255,255,.09), rgba(255,255,255,.04) 35%, rgba(0,0,0,0) 70%);
      filter:blur(.2px);
    }
    .hero-figure img{position:relative;z-index:1;display:block;width:100%;height:auto;object-fit:contain;object-position:center;filter:drop-shadow(0 10px 24px rgba(0,0,0,.45))}

    /* Tokenomics cards */
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .card{background:rgba(6,16,19,.6);border:1px solid var(--line);border-radius:12px;padding:12px}
    .card .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .card .value{font-size:18px;font-weight:800}

    /* Presale progress */
    .progress-area{position:relative;margin-top:14px;padding:12px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,#071417,#061013)}
    .progress-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .progress-head h3{margin:0;font-size:16px}
    .track{position:relative;height:16px;border-radius:10px;background:#0a1719;overflow:hidden;border:1px solid var(--line)}
    .bar{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,#3fb8ff,#5fe1a0)}
    .rocket{position:absolute;top:-48px;left:0;transform:translateX(0)}
    .rocket img{width:58px;height:auto;filter:drop-shadow(0 6px 16px rgba(0,0,0,.4));display:block}
    .progress-meta{display:flex;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--muted)}
    .progress-meta b{color:var(--txt)}

    /* Tables & layout */
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
    th{color:var(--muted);font-weight:600}

    /* Chat */
    .chatHead{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#133026;border:1px solid #215444;color:var(--pri);padding:6px 10px;border-radius:999px;font-weight:700}
    .mod{background:#2a1c1f;border:1px solid #5e2b33;color:#ff9aa9}
    .chatBox{height:220px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(6,16,19,.45)}
    .chatInput{display:flex;gap:8px;margin-top:8px}
    .input{background:#0a1416;border:1px solid var(--line);color:var(--txt);border-radius:10px;padding:10px 12px;flex:1}

    /* Modal (fermÃ©e par dÃ©faut) */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:200}
    .modal.open{display:flex}
    .modal-panel{width:min(980px,92vw);height:min(720px,86vh);background:#0c1718;border:1px solid var(--line);border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}

    /* Responsive */
    @media (max-width:980px){
      h1{font-size:34px}
      .nav{flex-wrap:wrap}
      .links{gap:12px}
      .actions{width:100%;justify-content:flex-start}
      .hero-grid{grid-template-columns:1fr}
      .cards{grid-template-columns:1fr 1fr}
      .hero-figure{width:min(76vw,560px);justify-self:center;margin-top:10px}
      .hero-figure::before{inset:-10% -12% -12% -12%}
      .stats{grid-template-columns:1fr 1fr}
      .rocket{top:-44px}
      .rocket img{width:52px}
    }
    @media (max-width:560px){
      h1{font-size:28px}
      .cards,.stats{grid-template-columns:1fr}
      .links{display:none}
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="wrap nav">
    <div class="brand">
      <img src="assets/kixy-coin.png" alt="KIXY"/>
      <span id="navBrand">MonkeyKixy</span>
    </div>

    <nav class="links">
      <a href="#story" data-i18n="nav.story">Histoire</a>
      <a href="#tokenomics" data-i18n="nav.tokenomics">Tokenomics</a>
      <a href="#presale" data-i18n="nav.presale">PrÃ©vente</a>
      <a href="#game" data-i18n="nav.game">Jeu</a>
      <a href="#posts" data-i18n="nav.posts">Posts</a>
      <a href="#chat" data-i18n="nav.chat">Chat</a>
      <a href="#staking" data-i18n="nav.staking">Staking</a>
      <a href="#winners" data-i18n="nav.winners">Gagnants</a>
    </nav>

    <div class="actions">
<select id="langSel" class="select" aria-label="Language">
  <option value="fr">FR</option>
  <option value="en">EN</option>
  <option value="es">ES</option>
  <option value="zh">ä¸­æ–‡</option>
</select>

      <button id="connectBtn" class="btn" data-i18n="btn.connect">Connecter le wallet</button>
      <button id="openCard" class="btn primary" data-i18n="btn.buyCard">Acheter (carte)</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- HERO -->
  <section class="panel">
    <div class="hero-grid">
      <div>
        <h1>
          <span class="grad">MonkeyKixy</span> â€” <span id="heroTitle" data-i18n="hero.title">De la jungle Ã  la lune</span>
          <div class="sub" id="heroSubtitle" data-i18n="hero.subtitle">Kixy sur la route vers 1 $</div>
        </h1>
        <p class="lead" id="heroLead" data-i18n-html="hero.lead">
          Kixy vivait au cÅ“ur dâ€™une jungle de nÃ©ons. Une nuit, la canopÃ©e bourdonna dâ€™un nouveau son : <em>Bitcoin</em>.
          Curieux et intrÃ©pide, Kixy suivit le signal Ã  travers les lianes et les vallÃ©es, apprit les inscriptions,
          rassembla des amis et construisit une fusÃ©e. Prochain arrÃªt : la lune.
        </p>
        <div class="cta-row">
          <a class="btn primary" href="#presale" id="ctaJoin" data-i18n="cta.joinPresale">Rejoindre la prÃ©vente</a>
          <a class="btn ghost" href="#story" id="ctaRead" data-i18n="cta.readStory">Lire lâ€™histoire</a>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="label" id="lblConn" data-i18n="stats.addr">Adresse connectÃ©e</div>
            <div id="addr" class="value">â€”</div>
          </div>
          <div class="stat">
            <div class="label" id="lblBtc" data-i18n="stats.btc">Solde BTC</div>
            <div id="btcBal" class="value">â€”</div>
          </div>
          <div class="stat">
            <div class="label" id="lblKixy" data-i18n="stats.kixy">KIXY (BRC-20)</div>
            <div id="kixyBal" class="value">â€”</div>
          </div>
        </div>
      </div>

      <figure class="hero-figure">
        <img src="assets/kixy-coin.png" alt="Gros Kixy" width="1000" height="1200"/>
      </figure>
    </div>
  </section>

  <!-- STORY -->
  <section id="story" class="panel alt">
    <h2 id="storyTitle" data-i18n="story.title">Lâ€™histoire</h2>
    <p id="storyText" data-i18n="story.text">
      Des rumeurs concernant Bitcoin rÃ©sonnaient dans la jungle. Kixy sâ€™est mis Ã  lâ€™Ã©coute, a appris Ã  sâ€™inscrire sur la
      blockchain et a commencÃ© Ã  partager une mine de connaissances avec chaque voyageur. MonkeyKixy est cette histoire
      Ã©crite en code : une aventure mÃ¨me lÃ©gÃ¨re, portÃ©e par une vraie communautÃ©.
    </p>
  </section>

  <!-- TOKENOMICS -->
  <section id="tokenomics" class="panel">
    <h2 data-i18n="tokenomics.title">Tokenomics</h2>
    <div class="cards">
      <div class="card"><div class="label" data-i18n="tokenomics.ticker">Ticker</div><div class="value">KIXY</div></div>
      <div class="card"><div class="label" data-i18n="tokenomics.max">Max Supply</div><div class="value" id="maxSupply">12 345 678 910 KIXY</div></div>
      <div class="card"><div class="label" data-i18n="tokenomics.network">RÃ©seau</div><div class="value" id="network">Bitcoin (Inscriptions)</div></div>
      <div class="card"><div class="label" data-i18n="tokenomics.distribution">Distribution</div><div class="value" id="distribution">Community-first</div></div>
    </div>
    <p class="muted" data-i18n="tokenomics.note">DÃ©tails & explorateurs publiÃ©s au fil des features.</p>
  </section>

  <!-- PRESALE -->
  <section id="presale" class="panel">
    <h2 data-i18n="presale.title">PrÃ©vente</h2>

    <div class="progress-area">
      <div class="progress-head">
        <h3 id="progressHead" data-i18n="presale.progressTitle">Progression de la prÃ©vente</h3>
        <div class="muted"><span data-i18n="presale.fixedPrice">Prix fixe</span> : <b id="priceUsd">$0,001</b> / KIXY</div>
      </div>

      <div class="track"><div id="bar" class="bar"></div></div>
      <div id="rocket" class="rocket" aria-hidden="true">
        <img src="assets/kixy-rocket.png" alt="Kixy sur la fusÃ©e">
      </div>

      <div class="progress-meta">
        <span><span data-i18n="presale.progress">Progression</span> : <b id="progressPct">0%</b></span>
        <span><span data-i18n="presale.sold">Vendus</span> : <b id="soldLbl">0</b> / <b id="capLbl">â€”</b> KIXY</span>
      </div>
    </div>

    <div class="cards" style="margin-top:12px;grid-template-columns:repeat(3,1fr)">
      <div class="card"><div class="label" data-i18n="presale.tokens">Tokens en prÃ©vente</div><div id="presaleCount" class="value">â€”</div></div>
      <div class="card"><div class="label" data-i18n="presale.price">Prix</div><div class="value" id="priceValue">$0,001 / KIXY</div></div>
      <div class="card">
        <div class="label" data-i18n="presale.buy">Acheter</div>
        <div class="value">
          <button class="btn primary" id="openCard2" data-i18n="btn.buyCard">Acheter (carte)</button>
        </div>
      </div>
    </div>
  </section>

  <!-- GAME -->
  <section id="game" class="panel alt">
    <h2 data-i18n="game.title">Jeu â€” KIXY Run</h2>
    <p class="muted" data-i18n="game.sub">10 niveaux, obstacles, coffres, pari en KIXY, XP et classement.</p>
    <div class="stats">
      <div class="stat"><div class="label" data-i18n="game.rank">Votre rang</div><div id="rankBadge" class="value">ğŸŒ± Recruit</div></div>
      <div class="stat"><div class="label" data-i18n="game.xp">XP</div><div id="xpVal" class="value">0</div></div>
      <div class="stat"><div class="label" data-i18n="game.nickname">Pseudo</div><div id="pseudoVal" class="value">â€”</div></div>
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <div id="gameCanvasLabel" style="height:220px;border:1px dashed var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--muted)" data-i18n="game.canvas">
          Canvas du jeu (placeholder)
        </div>
        <div class="cta-row">
          <input id="betKixy" class="input" data-i18n-ph="game.betPh" placeholder="Mise (KIXY)" style="max-width:220px"/>
          <button id="startGameBtn" class="btn primary" data-i18n="game.play">Jouer</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin:6px 0 8px" data-i18n="game.rulesQuick">RÃ¨gles rapides</h3>
        <ul class="muted">
          <li data-i18n="game.rule1">Finir un niveau = XP + multiplicateur de mise possible.</li>
          <li data-i18n="game.rule2">Ã‰chec = perte de la mise du niveau en cours.</li>
          <li data-i18n="game.rule3">Bonus dâ€™XP si vous stakiez KIXY (voir Staking).</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- POSTS -->
  <section id="posts" class="panel">
    <h2 data-i18n="posts.title">Posts â€” Crypto</h2>
    <p class="muted" data-i18n="posts.sub">Actus & tutos courts pour la communautÃ©.</p>
    <div id="postsGrid" class="cards" style="grid-template-columns:repeat(3,1fr)"></div>
  </section>

  <!-- CHAT -->
  <section id="chat" class="panel alt">
    <h2 data-i18n="chat.title">Chat â€” Rooms par langue</h2>
    <div class="chatHead">
      <span class="badge" id="roomBadge">Room: FR</span>
      <span class="badge" id="userBadge">Pseudo: â€”</span>
      <span class="badge mod" id="modBadge" style="display:none">MOD</span>
    </div>
    <div id="chatBox" class="chatBox"></div>
    <div class="chatInput">
      <input id="chatMsg" class="input" data-i18n-ph="chat.writePh" placeholder="Ã‰crire un messageâ€¦"/>
      <button id="sendMsg" class="btn" data-i18n="chat.send">Envoyer</button>
      <button id="delMsg" class="btn ghost" style="display:none">Supprimer (mod)</button>
      <button id="banUser" class="btn ghost" style="display:none">Ban (mod)</button>
    </div>
  </section>

  <!-- STAKING -->
  <section id="staking" class="panel">
    <h2 data-i18n="staking.title">Staking</h2>
    <p class="muted" data-i18n="staking.sub">Gagnez de lâ€™XP bonus et des points via le staking. Interface dÃ©mo ci-dessous (branchements Ã  venir).</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <div class="label" data-i18n="staking.amount">Montant Ã  staker (KIXY)</div>
        <input id="stakeAmt" class="input" placeholder="ex: 10000"/>
        <div class="label" style="margin-top:8px" data-i18n="staking.duration">DurÃ©e (jours)</div>
        <input id="stakeDays" class="input" type="number" value="30"/>
        <div class="cta-row"><button id="stakeBtn" class="btn primary" data-i18n="staking.start">DÃ©marrer le staking</button></div>
      </div>
      <div class="card">
        <div class="label" data-i18n="staking.estimate">Estimation</div>
        <div id="stakeEst" class="value">XP bonus â‰ˆ 0</div>
        <div class="muted" style="margin-top:6px" data-i18n="staking.hint">Calcul indicatif : XP â‰ˆ montant Ã— (jours/30) Ã— 0,5</div>
      </div>
    </div>
  </section>

  <!-- WINNERS -->
  <section id="winners" class="panel">
    <h2 data-i18n="winners.title">Gagnants</h2>
    <p class="muted" data-i18n="winners.sub">Affichage des gros gagnants (valeur &gt; 1 000 $) â€” arrive bientÃ´t.</p>
    <table>
      <thead>
        <tr>
          <th data-i18n="winners.th1">Pseudo / Wallet</th>
          <th data-i18n="winners.th2">Gain (KIXY)</th>
          <th data-i18n="winners.th3">Valeur (USD)</th>
          <th data-i18n="winners.th4">Date</th>
        </tr>
      </thead>
      <tbody id="winnersBody"></tbody>
    </table>
  </section>
</main>

<footer class="site-footer">
  <div class="wrap">
    <small class="muted">Â© <span id="y"></span> MonkeyKixy</small>
  </div>
</footer>

<!-- Modal Carte (MoonPay/Ramp) â€” FERMÃ‰E PAR DÃ‰FAUT -->
<div id="cardModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="cardTitle">
  <div class="modal-panel">
    <div class="modal-head">
      <h3 id="cardTitle" style="margin:0" data-i18n="card.title">Acheter KIXY â€” Paiement par carte</h3>
      <button id="closeCard" class="btn" data-i18n="btn.close">Fermer</button>
    </div>
    <div style="padding:12px;display:grid;gap:10px">
      <div class="muted"><span data-i18n="card.addr">Votre adresse BTC (rÃ©ception des <b>KIXY</b>) :</span> <b id="recvBtc2">â€”</b></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="wantKixy" class="input" type="number" min="1000" step="1000" data-i18n-ph="card.kixyPh" placeholder="KIXY souhaitÃ©s (ex: 50000)" style="max-width:260px">
        <div class="badge" id="priceBadge">Prix fixe: $0,001 / KIXY</div>
      </div>
      <div id="cardQuote" class="muted">Montant: â€”</div>
      <iframe id="cardFrame" style="width:100%;height:520px;border:0;display:none" title="Checkout"></iframe>
      <small class="muted" data-i18n="card.note">Le processeur achÃ¨te du <b>BTC</b> et lâ€™envoie directement au vendeur. Les KIXY sont livrÃ©s aprÃ¨s confirmation on-chain.</small>
    </div>
  </div>
</div>

<!-- Sats Connect (Xverse/Leather) -->
<script type="module" src="https://cdn.jsdelivr.net/npm/sats-connect/+esm"></script>

<script>
/** ===== CONFIG ===== **/
const CONFIG = {
  PRICE_USD_PER_KIXY: 0.001,                         // $/KIXY
  TOTAL_SUPPLY: 12345678910,                         // 12 345 678 910
  PRESALE_TOKENS: Math.floor(12345678910*0.10),      // 10% target
  API_BASE: "/api",
  INDEXER_BTC_BAL: null,
  MOD_WALLETS: ["bc1pYOURCREATORWALLET..."],

  // Paiement carte -> BTC directement vers le vendeur
  SELLER_BTC_ADDRESS: "bc1qscg2hmyp6u6drqn7xrshw7x4nek3hytj9sxuat",
  MOONPAY_API_KEY: "REPLACE_WITH_YOUR_MOONPAY_PUBLIC_KEY" // si vide, fallback Ramp
};

/** ===== I18N ===== **/
const I18N = {
  fr:{
    "nav.story":"Histoire","nav.tokenomics":"Tokenomics","nav.presale":"PrÃ©vente","nav.game":"Jeu","nav.posts":"Posts","nav.chat":"Chat","nav.staking":"Staking","nav.winners":"Gagnants",
    "btn.connect":"Connecter le wallet","btn.buyCard":"Acheter (carte)","btn.close":"Fermer",
    "hero.title":"De la jungle Ã  la lune","hero.subtitle":"Kixy sur la route vers 1 $",
    "hero.lead":"Kixy vivait au cÅ“ur dâ€™une jungle de nÃ©ons. Une nuit, la canopÃ©e bourdonna dâ€™un nouveau son : <em>Bitcoin</em>. Curieux et intrÃ©pide, Kixy suivit le signal Ã  travers les lianes et les vallÃ©es, apprit les inscriptions, rassembla des amis et construisit une fusÃ©e. Prochain arrÃªt : la lune.",
    "cta.joinPresale":"Rejoindre la prÃ©vente","cta.readStory":"Lire lâ€™histoire",
    "stats.addr":"Adresse connectÃ©e","stats.btc":"Solde BTC","stats.kixy":"KIXY (BRC-20)",
    "story.title":"Lâ€™histoire","story.text":"Des rumeurs concernant Bitcoin rÃ©sonnaient dans la jungle. Kixy sâ€™est mis Ã  lâ€™Ã©coute, a appris Ã  sâ€™inscrire sur la blockchain et a commencÃ© Ã  partager une mine de connaissances avec chaque voyageur. MonkeyKixy est cette histoire Ã©crite en code : une aventure mÃ¨me lÃ©gÃ¨re, portÃ©e par une vraie communautÃ©.",
    "tokenomics.title":"Tokenomics","tokenomics.ticker":"Ticker","tokenomics.max":"Max Supply","tokenomics.network":"RÃ©seau","tokenomics.distribution":"Distribution","tokenomics.note":"DÃ©tails & explorateurs publiÃ©s au fil des features.",
    "presale.title":"PrÃ©vente","presale.progressTitle":"Progression de la prÃ©vente","presale.fixedPrice":"Prix fixe","presale.progress":"Progression","presale.sold":"Vendus","presale.tokens":"Tokens en prÃ©vente","presale.price":"Prix","presale.buy":"Acheter",
    "game.title":"Jeu â€” KIXY Run","game.sub":"10 niveaux, obstacles, coffres, pari en KIXY, XP et classement.","game.rank":"Votre rang","game.xp":"XP","game.nickname":"Pseudo","game.canvas":"Canvas du jeu (placeholder)","game.betPh":"Mise (KIXY)","game.play":"Jouer","game.rulesQuick":"RÃ¨gles rapides","game.rule1":"Finir un niveau = XP + multiplicateur de mise possible.","game.rule2":"Ã‰chec = perte de la mise du niveau en cours.","game.rule3":"Bonus dâ€™XP si vous stakiez KIXY (voir Staking).",
    "posts.title":"Posts â€” Crypto","posts.sub":"Actus & tutos courts pour la communautÃ©.",
    "chat.title":"Chat â€” Rooms par langue","chat.writePh":"Ã‰crire un messageâ€¦","chat.send":"Envoyer",
    "staking.title":"Staking","staking.sub":"Gagnez de lâ€™XP bonus et des points via le staking. Interface dÃ©mo ci-dessous (branchements Ã  venir).","staking.amount":"Montant Ã  staker (KIXY)","staking.duration":"DurÃ©e (jours)","staking.start":"DÃ©marrer le staking","staking.estimate":"Estimation","staking.hint":"Calcul indicatif : XP â‰ˆ montant Ã— (jours/30) Ã— 0,5",
    "winners.title":"Gagnants","winners.sub":"Affichage des gros gagnants (valeur > 1 000 $) â€” arrive bientÃ´t.","winners.th1":"Pseudo / Wallet","winners.th2":"Gain (KIXY)","winners.th3":"Valeur (USD)","winners.th4":"Date",
    "card.title":"Acheter KIXY â€” Paiement par carte","card.addr":"Votre adresse BTC (rÃ©ception des <b>KIXY</b>) :","card.kixyPh":"KIXY souhaitÃ©s (ex: 50000)","card.note":"Le processeur achÃ¨te du <b>BTC</b> et lâ€™envoie directement au vendeur. Les KIXY sont livrÃ©s aprÃ¨s confirmation on-chain."
  },
  en:{
    "nav.story":"Story","nav.tokenomics":"Tokenomics","nav.presale":"Presale","nav.game":"Game","nav.posts":"Posts","nav.chat":"Chat","nav.staking":"Staking","nav.winners":"Winners",
    "btn.connect":"Connect Wallet","btn.buyCard":"Buy (card)","btn.close":"Close",
    "hero.title":"From the jungle to the moon","hero.subtitle":"Kixy on the road to $1",
    "hero.lead":"Kixy lived deep in a neon jungle. One night the canopy hummed with a new sound: <em>Bitcoin</em>. Curious and fearless, Kixy followed the signal across vines and valleys, learned inscriptions, rallied friends, and built a rocket. Next stop: the moon.",
    "cta.joinPresale":"Join Presale","cta.readStory":"Read the Story",
    "stats.addr":"Connected address","stats.btc":"BTC balance","stats.kixy":"KIXY (BRC-20)",
    "story.title":"The Story","story.text":"Whispers of Bitcoin echoed through the jungle. Kixy tuned in, learned to write on-chain, and began sharing knowledge with every traveler. MonkeyKixy is that tale written in code: a light-hearted meme adventure powered by a real community.",
    "tokenomics.title":"Tokenomics","tokenomics.ticker":"Ticker","tokenomics.max":"Max Supply","tokenomics.network":"Network","tokenomics.distribution":"Distribution","tokenomics.note":"Explorer links and details will roll out as features go live.",
    "presale.title":"Presale","presale.progressTitle":"Presale Progress","presale.fixedPrice":"Fixed price","presale.progress":"Progress","presale.sold":"Sold","presale.tokens":"Tokens in presale","presale.price":"Price","presale.buy":"Buy",
    "game.title":"Game â€” KIXY Run","game.sub":"10 levels, obstacles, chests, KIXY bets, XP, leaderboard.","game.rank":"Your rank","game.xp":"XP","game.nickname":"Nickname","game.canvas":"Game canvas (placeholder)","game.betPh":"Bet (KIXY)","game.play":"Play","game.rulesQuick":"Quick rules","game.rule1":"Beat a level = XP + possible stake multiplier.","game.rule2":"Fail = lose the current level stake.","game.rule3":"XP bonus if you stake KIXY (see Staking).",
    "posts.title":"Posts â€” Crypto","posts.sub":"Short news & tutorials for the community.",
    "chat.title":"Chat â€” Language rooms","chat.writePh":"Write a messageâ€¦","chat.send":"Send",
    "staking.title":"Staking","staking.sub":"Earn bonus XP and points via staking. Demo UI below (wiring to come).","staking.amount":"Amount to stake (KIXY)","staking.duration":"Duration (days)","staking.start":"Start staking","staking.estimate":"Estimate","staking.hint":"Indicative calc: XP â‰ˆ amount Ã— (days/30) Ã— 0.5",
    "winners.title":"Winners","winners.sub":"Top winners (value > $1,000) â€” coming soon.","winners.th1":"Handle / Wallet","winners.th2":"Win (KIXY)","winners.th3":"Value (USD)","winners.th4":"Date",
    "card.title":"Buy KIXY â€” Pay by Card","card.addr":"Your BTC address (to receive <b>KIXY</b>):","card.kixyPh":"Desired KIXY (e.g., 50000)","card.note":"The processor buys <b>BTC</b> and sends it directly to the seller. KIXY is delivered after on-chain confirmation."
  },
  es:{
    "nav.story":"Historia","nav.tokenomics":"Tokenomics","nav.presale":"Preventa","nav.game":"Juego","nav.posts":"Posts","nav.chat":"Chat","nav.staking":"Staking","nav.winners":"Ganadores",
    "btn.connect":"Conectar wallet","btn.buyCard":"Comprar (tarjeta)","btn.close":"Cerrar",
    "hero.title":"De la jungla a la luna","hero.subtitle":"Kixy rumbo a 1 $",
    "hero.lead":"Kixy vivÃ­a en una jungla de neÃ³n. Una noche la copa del bosque vibrÃ³ con un nuevo sonido: <em>Bitcoin</em>. Curioso y valiente, siguiÃ³ la seÃ±al, aprendiÃ³ inscripciones, reuniÃ³ amigos y construyÃ³ un cohete. PrÃ³xima parada: la luna.",
    "cta.joinPresale":"Unirse a la preventa","cta.readStory":"Leer la historia",
    "stats.addr":"DirecciÃ³n conectada","stats.btc":"Saldo BTC","stats.kixy":"KIXY (BRC-20)",
    "story.title":"La Historia","story.text":"Susurros de Bitcoin resonaban por la jungla. Kixy escuchÃ³, aprendiÃ³ a escribir on-chain y compartiÃ³ conocimiento con cada viajero. MonkeyKixy es ese relato en cÃ³digo: una aventura meme ligera impulsada por una comunidad real.",
    "tokenomics.title":"Tokenomics","tokenomics.ticker":"Ticker","tokenomics.max":"Suministro mÃ¡ximo","tokenomics.network":"Red","tokenomics.distribution":"DistribuciÃ³n","tokenomics.note":"Los detalles y exploradores se publicarÃ¡n a medida que salgan las funciones.",
    "presale.title":"Preventa","presale.progressTitle":"Progreso de la preventa","presale.fixedPrice":"Precio fijo","presale.progress":"Progreso","presale.sold":"Vendidos","presale.tokens":"Tokens en preventa","presale.price":"Precio","presale.buy":"Comprar",
    "game.title":"Juego â€” KIXY Run","game.sub":"10 niveles, obstÃ¡culos, cofres, apuestas en KIXY, XP y clasificaciÃ³n.","game.rank":"Tu rango","game.xp":"XP","game.nickname":"Apodo","game.canvas":"Lienzo del juego (marcador)","game.betPh":"Apuesta (KIXY)","game.play":"Jugar","game.rulesQuick":"Reglas rÃ¡pidas","game.rule1":"Superar un nivel = XP + posible multiplicador de apuesta.","game.rule2":"Fallar = perder la apuesta del nivel.","game.rule3":"Bono de XP si haces staking de KIXY (ver Staking).",
    "posts.title":"Posts â€” Cripto","posts.sub":"Noticias y tutoriales cortos para la comunidad.",
    "chat.title":"Chat â€” Salas por idioma","chat.writePh":"Escribe un mensajeâ€¦","chat.send":"Enviar",
    "staking.title":"Staking","staking.sub":"Gana XP y puntos extra con staking. Interfaz demo abajo (conexiones por venir).","staking.amount":"Cantidad a hacer staking (KIXY)","staking.duration":"DuraciÃ³n (dÃ­as)","staking.start":"Iniciar staking","staking.estimate":"EstimaciÃ³n","staking.hint":"CÃ¡lculo indicativo: XP â‰ˆ cantidad Ã— (dÃ­as/30) Ã— 0,5",
    "winners.title":"Ganadores","winners.sub":"Grandes ganadores (valor > 1.000 $) â€” pronto.","winners.th1":"Apodo / Wallet","winners.th2":"Ganancia (KIXY)","winners.th3":"Valor (USD)","winners.th4":"Fecha",
    "card.title":"Comprar KIXY â€” Pago con tarjeta","card.addr":"Tu direcciÃ³n BTC (para recibir <b>KIXY</b>):","card.kixyPh":"KIXY deseados (p. ej., 50000)","card.note":"El procesador compra <b>BTC</b> y lo envÃ­a directamente al vendedor. KIXY se entrega tras la confirmaciÃ³n on-chain."
  },
  zh:{
    "nav.story":"æ•…äº‹","nav.tokenomics":"ä»£å¸ç»æµ","nav.presale":"é¢„å”®","nav.game":"æ¸¸æˆ","nav.posts":"æ–‡ç« ","nav.chat":"èŠå¤©","nav.staking":"è´¨æŠ¼","nav.winners":"èµ¢å®¶",
    "btn.connect":"è¿æ¥é’±åŒ…","btn.buyCard":"é“¶è¡Œå¡è´­ä¹°","btn.close":"å…³é—­",
    "hero.title":"ä»ä¸›æ—åˆ°æœˆçƒ","hero.subtitle":"Kixy ç›®æ ‡ 1 ç¾å…ƒ",
    "hero.lead":"Kixy ç”Ÿæ´»åœ¨éœ“è™¹ä¸›æ—ã€‚æŸæ™šæ ‘å† ä¼ æ¥æ–°å£°éŸ³ï¼š<em>æ¯”ç‰¹å¸</em>ã€‚ä»–å¥½å¥‡æ— ç•ï¼Œå¾ªè¿¹ç©¿è¿‡è—¤è”“ä¸å±±è°·ï¼Œå­¦ä¹ é“­æ–‡ï¼Œå¬é›†ä¼™ä¼´ï¼Œé€ å¥½ç«ç®­ã€‚ä¸‹ä¸€ç«™ï¼šæœˆçƒã€‚",
    "cta.joinPresale":"å‚ä¸é¢„å”®","cta.readStory":"é˜…è¯»æ•…äº‹",
    "stats.addr":"å·²è¿æ¥åœ°å€","stats.btc":"BTC ä½™é¢","stats.kixy":"KIXYï¼ˆBRC-20ï¼‰",
    "story.title":"æ•…äº‹","story.text":"æ¯”ç‰¹å¸çš„ä½è¯­å›è¡åœ¨ä¸›æ—ã€‚Kixy å€¾å¬å¹¶å­¦ä¼šåœ¨é“¾ä¸Šä¹¦å†™ï¼Œä¸æ—…äººåˆ†äº«çŸ¥è¯†ã€‚MonkeyKixy å°±æ˜¯é‚£æ®µæ•…äº‹çš„ä»£ç åŒ–ï¼šä¸€ä¸ªç”±çœŸå®ç¤¾åŒºé©±åŠ¨çš„è½»æ¾ meme å†’é™©ã€‚",
    "tokenomics.title":"ä»£å¸ç»æµ","tokenomics.ticker":"ä»£å·","tokenomics.max":"æœ€å¤§ä¾›ç»™","tokenomics.network":"ç½‘ç»œ","tokenomics.distribution":"åˆ†é…","tokenomics.note":"åŠŸèƒ½ä¸Šçº¿æ—¶å°†é€æ­¥å…¬å¸ƒè¯¦æƒ…ä¸æµè§ˆå™¨é“¾æ¥ã€‚",
    "presale.title":"é¢„å”®","presale.progressTitle":"é¢„å”®è¿›åº¦","presale.fixedPrice":"å›ºå®šä»·æ ¼","presale.progress":"è¿›åº¦","presale.sold":"å·²å”®","presale.tokens":"é¢„å”®æ•°é‡","presale.price":"ä»·æ ¼","presale.buy":"è´­ä¹°",
    "game.title":"æ¸¸æˆ â€” KIXY Run","game.sub":"10 å…³å¡ã€éšœç¢ã€å®ç®±ã€KIXY ä¸‹æ³¨ã€XP ä¸æ’è¡Œæ¦œã€‚","game.rank":"ä½ çš„æ®µä½","game.xp":"ç»éªŒ","game.nickname":"æ˜µç§°","game.canvas":"æ¸¸æˆç”»å¸ƒï¼ˆå ä½ï¼‰","game.betPh":"ä¸‹æ³¨ï¼ˆKIXYï¼‰","game.play":"å¼€å§‹","game.rulesQuick":"å¿«é€Ÿè§„åˆ™","game.rule1":"é€šå…³ = ç»éªŒ + ä¸‹æ³¨å€æ•°æœºä¼šã€‚","game.rule2":"å¤±è´¥ = å¤±å»æœ¬å…³ä¸‹æ³¨ã€‚","game.rule3":"è´¨æŠ¼ KIXY å¯è·ç»éªŒåŠ æˆï¼ˆè§è´¨æŠ¼ï¼‰ã€‚",
    "posts.title":"æ–‡ç«  â€” åŠ å¯†","posts.sub":"é¢å‘ç¤¾åŒºçš„å¿«è®¯ä¸æ•™ç¨‹ã€‚",
    "chat.title":"èŠå¤© â€” æŒ‰è¯­è¨€åˆ†æˆ¿","chat.writePh":"è¾“å…¥æ¶ˆæ¯â€¦","chat.send":"å‘é€",
    "staking.title":"è´¨æŠ¼","staking.sub":"é€šè¿‡è´¨æŠ¼è·å¾—é¢å¤–ç»éªŒä¸ç§¯åˆ†ã€‚ä¸‹æ–¹ä¸ºæ¼”ç¤ºç•Œé¢ï¼ˆç¨åæ¥å…¥ï¼‰ã€‚","staking.amount":"è´¨æŠ¼æ•°é‡ï¼ˆKIXYï¼‰","staking.duration":"æœŸé™ï¼ˆå¤©ï¼‰","staking.start":"å¼€å§‹è´¨æŠ¼","staking.estimate":"é¢„ä¼°","staking.hint":"ä¼°ç®—ï¼šç»éªŒ â‰ˆ æ•°é‡ Ã—ï¼ˆå¤©æ•°/30ï¼‰Ã— 0.5",
    "winners.title":"èµ¢å®¶","winners.sub":"å¤§å¥–å¾—ä¸»ï¼ˆä»·å€¼ > 1,000 ç¾å…ƒï¼‰â€” æ•¬è¯·æœŸå¾…ã€‚","winners.th1":"æ˜µç§° / é’±åŒ…","winners.th2":"æ”¶ç›Šï¼ˆKIXYï¼‰","winners.th3":"ä»·å€¼ï¼ˆUSDï¼‰","winners.th4":"æ—¥æœŸ",
    "card.title":"è´­ä¹° KIXY â€” é“¶è¡Œå¡","card.addr":"ä½ çš„ BTC åœ°å€ï¼ˆç”¨äºæ¥æ”¶<b>KIXY</b>ï¼‰ï¼š","card.kixyPh":"æœŸæœ›çš„ KIXYï¼ˆå¦‚ 50000ï¼‰","card.note":"æ”¯ä»˜å¤„ç†æ–¹è´­ä¹° <b>BTC</b> å¹¶ç›´æ¥å‘é€ç»™å–æ–¹ã€‚é“¾ä¸Šç¡®è®¤åå‘æ”¾ KIXYã€‚"
  }
};

function detectLang(){
  const forced = localStorage.getItem('kixy_lang');
  if(forced) return forced;
  const nav = (navigator.language||'en').toLowerCase();
  if(nav.startsWith('fr')) return 'fr';
  if(nav.startsWith('es')) return 'es';
  if(nav.startsWith('zh')) return 'zh';
  return 'en';
}

function applyI18n(lang){
  const t = I18N[lang] || I18N.en;
  document.documentElement.lang = lang;

  // data-i18n (textContent)
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(t[key]) el.textContent = t[key];
  });

  // data-i18n-html (innerHTML)
  document.querySelectorAll('[data-i18n-html]').forEach(el=>{
    const key = el.getAttribute('data-i18n-html');
    if(t[key]) el.innerHTML = t[key];
  });

  // placeholders
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key = el.getAttribute('data-i18n-ph');
    if(t[key]) el.setAttribute('placeholder', t[key]);
  });

// Map langue -> room de chat
const ROOM_BY_LANG = { fr:'FR', en:'EN', es:'ES', zh:'ZH' };

// Changement de langue (met Ã  jour tout le site sans recharger)
function setLang(l){
  localStorage.setItem('kixy_lang', l);
  applyI18n(l);
  // Met la room de chat sur la langue choisie
  state.room = ROOM_BY_LANG[l] || 'EN';
  // Re-render des zones qui dÃ©pendent de la locale
  renderProgress();
  renderUserUI();
  renderPosts();
  renderChat();
}


  // prix formatÃ© $0.001 / $0,001
  const dec = (lang==='fr'||lang==='es') ? ',' : '.';
  const pStr = '$0' + dec + '001';
  const per = pStr + ' / KIXY';
  const priceUsd = document.getElementById('priceUsd');
  const priceValue = document.getElementById('priceValue');
  const priceBadge = document.getElementById('priceBadge');
  if(priceUsd) priceUsd.textContent = pStr;
  if(priceValue) priceValue.textContent = per;
  if(priceBadge) priceBadge.textContent = (lang==='fr' ? 'Prix fixe: ' : lang==='es' ? 'Precio fijo: ' : lang==='zh' ? 'å›ºå®šä»·æ ¼ï¼š' : 'Fixed price: ') + per;

  // reformater nombres selon locale
  // (le rendu dynamique des compteurs utilise dÃ©jÃ  document.documentElement.lang)
}

/** ===== STATE ===== **/
let state = {
  connected: null,
  sold: 0, buyers: 0,
  cap: CONFIG.PRESALE_TOKENS,
  price_usd: CONFIG.PRICE_USD_PER_KIXY,
  xp: 0,
  rank: 'Recruit',
  room: (navigator.language||'en').slice(0,2).toUpperCase()
};

/** ===== HELPERS ===== **/
const $ = (s)=>document.querySelector(s);
const short = (a)=> a ? (a.slice(0,6)+"â€¦"+a.slice(-6)) : "â€”";
const fmt = (n)=> (n??0).toLocaleString(document.documentElement.lang||"fr",{maximumFractionDigits:0});
const ranks=[{r:'Recruit',min:0,emoji:'ğŸŒ±'},{r:'Explorer',min:5000,emoji:'ğŸ—ºï¸'},{r:'Captain',min:15000,emoji:'ğŸš€'},{r:'Legend',min:50000,emoji:'ğŸ¦'}];
function computeRank(xp){ for(let i=ranks.length-1;i>=0;i--){ if(xp>=ranks[i].min) return ranks[i]; } return ranks[0]; }
function pseudoFromWallet(addr){ if(!addr) return 'â€”'; const core=addr.replace(/^bc1[pq]?/,''); return `KIXY-${core.slice(0,4).toUpperCase()}${core.slice(-4).toUpperCase()}`; }
function usdFromKixy(k){ return Math.round((k||0)*(CONFIG.PRICE_USD_PER_KIXY||0.001)*100)/100; }

/** ===== RENDER ===== **/
function renderYear(){ $("#y").textContent = new Date().getFullYear(); }
function renderProgress(){
  $("#maxSupply").textContent = fmt(CONFIG.TOTAL_SUPPLY) + " KIXY";
  $("#presaleCount").textContent = fmt(state.cap);
  const dec = (document.documentElement.lang==='fr'||document.documentElement.lang==='es') ? ',' : '.';
  const pStr = '$0' + dec + '001';
  $("#priceUsd").textContent = pStr;
  $("#priceValue").textContent = pStr + " / KIXY";
  $("#soldLbl").textContent = fmt(state.sold);
  $("#capLbl").textContent = fmt(state.cap);
  const pct = Math.max(0, Math.min(100, Math.floor((state.sold/state.cap)*100)));
  $("#progressPct").textContent = pct + "%";
  $("#bar").style.width = pct + "%";
  const track = document.querySelector(".track");
  const rocketWrap = $("#rocket");
  const rocketImg = rocketWrap.querySelector("img");
  const rocketW = (rocketImg && rocketImg.clientWidth) ? rocketImg.clientWidth : 58;
  const W = Math.max(0, track.clientWidth - rocketW);
  rocketWrap.style.transform = "translateX("+(W * (pct/100))+"px)";
}
function renderUserUI(){
  const rk = computeRank(state.xp);
  state.rank = rk.r;
  $("#rankBadge").textContent = `${rk.emoji} ${rk.r}`;
  $("#xpVal").textContent = state.xp.toLocaleString();
  $("#roomBadge").textContent = 'Room: ' + state.room;
  $("#userBadge").textContent = 'Pseudo: ' + (state.connected ? pseudoFromWallet(state.connected.address) : 'â€”');
  $("#pseudoVal").textContent = state.connected ? pseudoFromWallet(state.connected.address) : 'â€”';
  const isMod = state.connected && CONFIG.MOD_WALLETS.includes(state.connected.address);
  $("#modBadge").style.display = isMod ? 'inline-flex' : 'none';
  $("#delMsg").style.display = isMod ? 'inline-flex' : 'none';
  $("#banUser").style.display = isMod ? 'inline-flex' : 'none';
}

/** ===== WALLET CONNECT (Bitcoin) ===== **/
async function connectWallet(){
  // UniSat si dispo
  if (window.unisat?.requestAccounts) {
    try{
      const acc = await window.unisat.requestAccounts();
      const address = acc[0];
      state.connected = {address, type:"unisat"};
      $("#addr").textContent = short(address);
      fetchBtcBalance(address);
      fetchKixyBalance(address);
      renderUserUI();
      return;
    }catch(e){}
  }
  // Xverse/Leather via Sats-Connect
  try{
    const { request, AddressPurpose, BitcoinNetworkType } = await import("https://cdn.jsdelivr.net/npm/sats-connect/+esm");
    await request("getAddresses", {
      getAddressesPayload:{ purposes:[AddressPurpose.PAYMENT], message:"Connexion Ã  MonkeyKixy", network:{ type: BitcoinNetworkType.Mainnet } },
      onFinish:(res)=>{ const a = res?.addresses?.[0]?.address;
        if (a){ state.connected={address:a,type:"satsconnect"}; $("#addr").textContent = short(a); fetchBtcBalance(a); fetchKixyBalance(a); renderUserUI(); } },
      onCancel:()=> alert("Connexion wallet annulÃ©e")
    });
  }catch(e){
    alert("Installe UniSat ou Xverse pour te connecter.");
  }
}
document.getElementById("connectBtn").addEventListener("click", connectWallet);

/** ===== BALANCES ===== **/
async function fetchBtcBalance(address){
  if (!CONFIG.INDEXER_BTC_BAL){ $("#btcBal").textContent="â€”"; return; }
  try{
    const r = await fetch(`${CONFIG.INDEXER_BTC_BAL}/address/${address}`);
    const j = await r.json();
    const sats = (j.chain_stats?.funded_txo_sum - j.chain_stats?.spent_txo_sum) || 0;
    $("#btcBal").textContent = (sats/1e8).toFixed(8) + " BTC";
  }catch(e){ $("#btcBal").textContent="â€”"; }
}
async function fetchKixyBalance(address){
  try{
    const r = await fetch(`${CONFIG.API_BASE}/balance?address=${encodeURIComponent(address)}&ticker=KIXY`);
    if (r.ok){ const j = await r.json(); $("#kixyBal").textContent = (j.kixy??0).toLocaleString(); }
    else{ $("#kixyBal").textContent = "â€”"; }
  }catch(e){ $("#kixyBal").textContent = "â€”"; }
}

/** ===== BACKEND (facultatif) ===== **/
async function fetchConfig(){
  try{
    const r = await fetch(`${CONFIG.API_BASE}/config`);
    if (r.ok){
      const j = await r.json();
      state.cap = j.presale_tokens ?? CONFIG.PRESALE_TOKENS;
      state.price_usd = j.price_usd ?? CONFIG.PRICE_USD_PER_KIXY;
    }
  }catch(e){}
}
async function fetchProgress(){
  try{
    const r = await fetch(`${CONFIG.API_BASE}/progress`);
    if (r.ok){
      const j = await r.json();
      state.sold = j.sold ?? state.sold;
      state.buyers = j.buyers ?? state.buyers;
    }else{
      const demo = Number(localStorage.getItem("kixy_demo_sold")||"0");
      state.sold = Math.min(state.cap, demo);
    }
  }catch(e){
    const demo = Number(localStorage.getItem("kixy_demo_sold")||"0");
    state.sold = Math.min(state.cap, demo);
  }
  renderProgress();
}
window.demoSell = (q)=>{
  const n = Math.min(state.cap, Number(localStorage.getItem("kixy_demo_sold")||"0") + (q||0));
  localStorage.setItem("kixy_demo_sold", String(n));
  fetchProgress();
}

/** ===== GAME (placeholder + XP) ===== **/
document.getElementById('startGameBtn').addEventListener('click', ()=>{
  if(!state.connected) return alert(document.documentElement.lang==='fr'?'Connecte ton wallet dâ€™abord.':document.documentElement.lang==='es'?'Conecta tu wallet primero.':document.documentElement.lang==='zh'?'è¯·å…ˆè¿æ¥é’±åŒ…ã€‚':'Connect your wallet first.');
  const bet = Number(document.getElementById('betKixy').value||0);
  if(bet<=0) return alert(document.documentElement.lang==='fr'?'Entre une mise.':document.documentElement.lang==='es'?'Introduce una apuesta.':document.documentElement.lang==='zh'?'è¯·è¾“å…¥ä¸‹æ³¨ã€‚':'Enter a bet.');
  const win = Math.random() < 0.6;
  if(win){ state.xp += Math.round(bet*2); alert(document.documentElement.lang==='fr'?'Niveau rÃ©ussi ! +XP':document.documentElement.lang==='es'?'Â¡Nivel superado! +XP':document.documentElement.lang==='zh'?'é€šå…³ï¼+ç»éªŒ':'Level cleared! +XP'); }
  else{ alert(document.documentElement.lang==='fr'?'RatÃ©. Perte de la mise du niveau.':document.documentElement.lang==='es'?'Fallaste. Pierdes la apuesta del nivel.':document.documentElement.lang==='zh'?'å¤±è´¥ã€‚æœ¬å…³ä¸‹æ³¨æŸå¤±ã€‚':'Failed. Lost the level stake.'); }
  renderUserUI();
});

/** ===== POSTS (placeholder) ===== **/
const demoPosts=[
  {title:"Guide UniSat / Xverse", excerpt:"Installer, sÃ©curiser, connecter au site.", tag:"Tutoriel"},
  {title:"Comprendre les inscriptions", excerpt:"BRC-20 en 3 minutes chrono.", tag:"Basics"},
  {title:"SÃ©curitÃ©: 5 piÃ¨ges Ã  Ã©viter", excerpt:"ClÃ©s, seed phrase, dApps, phishingâ€¦", tag:"SÃ©curitÃ©"},
  {title:"Tokenomics KIXY", excerpt:"Supply, utilitÃ©, XP, jeux, staking.", tag:"KIXY"},
  {title:"Comment participer Ã  la prÃ©vente", excerpt:"Ã‰tapes simples pour acheter.", tag:"Achat"},
  {title:"Roadmap CommunautÃ©", excerpt:"Ce quâ€™on construit ensuite.", tag:"Roadmap"},
];
function renderPosts(){
  const g=$("#postsGrid"); g.innerHTML='';
  demoPosts.forEach(p=>{
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<div class="label">${p.tag}</div><div class="value" style="font-size:16px">${p.title}</div><p class="muted" style="margin:6px 0 0">${p.excerpt}</p>`;
    g.appendChild(el);
  });
}

/** ===== CHAT (rooms par langue) ===== **/
const chat = { FR:[], EN:[], ES:[], ZH:[] };
function addMsg(room, user, text){
  chat[room] = chat[room]||[];
  chat[room].push({user,text,ts:new Date()});
  renderChat();
}
function renderChat(){
  const room = state.room;
  $("#roomBadge").textContent = 'Room: ' + room;
  $("#userBadge").textContent = 'Pseudo: ' + (state.connected ? pseudoFromWallet(state.connected.address) : 'â€”');
  const box=$("#chatBox"); box.innerHTML='';
  (chat[room]||[]).slice(-50).forEach(m=>{
    const line=document.createElement('div');
    line.innerHTML = `<strong>${m.user}</strong> <span class="muted" style="font-size:12px">${m.ts.toLocaleTimeString()}</span><br/>${m.text}`;
    line.style.marginBottom='8px';
    box.appendChild(line);
  });
  box.scrollTop = box.scrollHeight;
}
document.getElementById('sendMsg').addEventListener('click', ()=>{
  if(!state.connected) return alert(document.documentElement.lang==='fr'?'Connecte ton wallet.':document.documentElement.lang==='es'?'Conecta tu wallet.':document.documentElement.lang==='zh'?'è¯·è¿æ¥é’±åŒ…ã€‚':'Connect your wallet.');
  const txt = document.getElementById('chatMsg').value.trim();
  if(!txt) return;
  addMsg(state.room, pseudoFromWallet(state.connected.address), txt);
  document.getElementById('chatMsg').value='';
});

/** ===== STAKING (dÃ©mo/calcul) ===== **/
document.getElementById('stakeBtn').addEventListener('click', ()=>{
  const amt = Number(document.getElementById('stakeAmt').value||0);
  const days = Math.max(1, Number(document.getElementById('stakeDays').value||30));
  const xp = Math.round(amt * (days/30) * 0.5);
  document.getElementById('stakeEst').textContent = 'XP bonus â‰ˆ ' + xp.toLocaleString();
  if(state.connected){ state.xp += Math.round(xp*0.1); renderUserUI(); }
});

/** ===== Paiement par carte â†’ BTC (MoonPay / Ramp fallback) ===== **/
function renderCardQuote(){
  const k = Math.max(1, Number(document.getElementById('wantKixy').value||0));
  const usd = usdFromKixy(k);
  const txt = (document.documentElement.lang==='fr'?'Montant indicatif: ':document.documentElement.lang==='es'?'Importe indicativo: ':document.documentElement.lang==='zh'?'å‚è€ƒé‡‘é¢ï¼š':'Indicative amount: ');
  document.getElementById('cardQuote').textContent = k ? `${txt}${k.toLocaleString()} KIXY â‰ˆ $${usd.toFixed(2)}` : (document.documentElement.lang==='fr'?'Montant: â€”':document.documentElement.lang==='es'?'Importe: â€”':document.documentElement.lang==='zh'?'é‡‘é¢ï¼šâ€”':'Amount: â€”');
}
function openCardModal(open){
  document.getElementById('cardModal').classList.toggle('open', !!open);
  const has = !!state.connected?.address;
  document.getElementById('recvBtc2').textContent = has ? state.connected.address : "â€”";
  if(!has){
    const msg = document.documentElement.lang==='fr'?'Connecte ton wallet Bitcoin (UniSat/Xverse) pour recevoir les KIXY.'
      : document.documentElement.lang==='es'?'Conecta tu wallet de Bitcoin (UniSat/Xverse) para recibir KIXY.'
      : document.documentElement.lang==='zh'?'è¯·è¿æ¥æ¯”ç‰¹å¸é’±åŒ…ï¼ˆUniSat/Xverseï¼‰ä»¥æ¥æ”¶ KIXYã€‚'
      : 'Connect your Bitcoin wallet (UniSat/Xverse) to receive KIXY.';
    alert(msg);
  }
}
async function openCardCheckout(){
  const k = Math.max(1, Number(document.getElementById('wantKixy').value||0));
  if(!k) return alert(document.documentElement.lang==='fr'?'Entre le nombre de KIXY.':document.documentElement.lang==='es'?'Introduce la cantidad de KIXY.':document.documentElement.lang==='zh'?'è¯·è¾“å…¥ KIXY æ•°é‡ã€‚':'Enter the number of KIXY.');
  const usd = usdFromKixy(k);

  // MoonPay embed si clÃ© dispo
  if (CONFIG.MOONPAY_API_KEY && !CONFIG.MOONPAY_API_KEY.includes("REPLACE_")){
    const p = new URLSearchParams({
      apiKey: CONFIG.MOONPAY_API_KEY,
      currencyCode: "btc",
      walletAddress: CONFIG.SELLER_BTC_ADDRESS,
      baseCurrencyCode: "usd",
      baseCurrencyAmount: String(usd),
      redirectURL: location.origin + "/merci"
    });
    const f = document.getElementById('cardFrame');
    f.src = "https://buy.moonpay.com/?" + p.toString();
    f.style.display = 'block';
    return;
  }
  // Fallback Ramp (ouvre un nouvel onglet)
  const p2 = new URLSearchParams({
    swapAsset: "BTC_BTC",
    finalUrl: location.origin + "/merci",
    userAddress: CONFIG.SELLER_BTC_ADDRESS
  });
  window.open("https://ramp.network/buy?" + p2.toString(), "_blank");
}
document.getElementById('openCard').addEventListener('click', ()=> { openCardModal(true); renderCardQuote(); });
document.getElementById('openCard2').addEventListener('click', ()=> { openCardModal(true); renderCardQuote(); });
document.getElementById('closeCard').addEventListener('click', ()=> openCardModal(false));
document.getElementById('wantKixy').addEventListener('input', renderCardQuote);

/** ===== INIT ===== **/
document.addEventListener("DOMContentLoaded", async ()=>{
  // i18n
  const lang = detectLang();
  applyI18n(lang);

  renderYear();
  renderUserUI();
  renderPosts();
  state.cap = CONFIG.PRESALE_TOKENS;
  await fetchConfig();
  await fetchProgress();
  setInterval(fetchProgress, 15000);
  addMsg(state.room, "System", (lang==='fr'?'Bienvenue dans le chat ':'Welcome to the ').concat(state.room,(lang==='fr'?' !':' room!')));
});
</script>
</body>
</html>
